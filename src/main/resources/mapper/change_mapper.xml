<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
	<mapper namespace="kr.co.book.transaction.dao.ChangeDAO">
	   	   		    
		<!-- 교환 신청 -->
		<insert id="changeapply">
			INSERT INTO `CHANGE`(MEMBER_IDX,LIBRARY_BOOK,LIBRARY_BOOK2,CHANGE_APPLYDATE,CHANGE_DATE,CHANGE_STATE) 
			VALUES(#{param1},#{param2},#{param3},now(),#{param4},0)
		</insert>
		
		<!-- 교환 IDX -->
		<select id="findchange_idx" resultType="String">		
			SELECT CHANGE_IDX  FROM `CHANGE`
			WHERE MEMBER_IDX = #{param1} AND LIBRARY_BOOK = #{param2} AND LIBRARY_BOOK2 = #{param3}			
		</select>
		
		<!-- 대화방 만들기 -->
		<insert id="createchatroom">
			INSERT INTO CHAT_ROOM(CODE_IDX,MEMBER_IDX,IDX,CHAT_ROOM_STATE) 
			VALUES(#{param1},#{param2},#{param3},0)
		</insert>
		
		<!-- 신청내역 대화방에 뿌려주기-->
		<insert id="applychatcontent">
			INSERT INTO CHAT(CODE_IDX,IDX,CHAT_SENDER,CHAT_RECIEVER,CHAT_CHAT,CHAT_CHECK,CHAT_DATE)
			VALUES(#{param1},#{param2},#{param3},#{param4},'안녕하세요',0,now())
		</insert>
		
		<!-- 책에 대한 정보 들고오기 -->
		<select id="findchbmidx" parameterType="hashmap" resultType="change">		
			SELECT * FROM LIBRARY WHERE LIBRARY_IDX = #{LIBRARY_IDX} 
		</select>
		
		<!-- 처음 교환 신청정보 -->
		<select id="chgreservation" resultType="hashmap">
			SELECT CHANGE_IDX, LIBRARY_BOOK2, CHANGE_DATE FROM `CHANGE`
			WHERE CHANGE_IDX = #{param1}
		</select>
		
		<!-- 교환 약속 잡기 -->
		<update id="updatechange" parameterType="hashmap">
			UPDATE `CHANGE` SET LIBRARY_BOOK2 = #{LIBRARY_BOOK2}, CHANGE_DATE = #{CHANGE_DATE}, 
			CHANGE_STATE = 1, MOD_MEMBER_IDX = #{MOD_MEMBER_IDX}, MOD_DATE = now()
			WHERE CHANGE_IDX = #{CHANGE_IDX}
		</update>
		
		<!-- 교환 약속된 책정보 가져오기 -->
		<select id="message_librarydetail" resultType="hashmap">
			SELECT LIBRARY_TITLE, LIBRARY_COVER, LIBRARY_INFO, LIBRARY_SHARESTATE FROM LIBRARY
			WHERE LIBRARY_IDX = #{param1} AND LIBRARY_BLIND = 0
		</select>
		
		<!-- 교환 약속정보 메세지 보내기 -->
		<insert id="chatchangereservation" parameterType="hashmap">	 
			INSERT INTO CHAT(CODE_IDX, IDX, CHAT_SENDER, CHAT_RECIEVER, CHAT_CHAT, CHAT_CHECK, CHAT_DATE)
			VALUES(#{CODE_IDX}, #{CHANGE_IDX}, #{MOD_MEMBER_IDX}, #{other_nick}, CONCAT('약속을 잡으셨습니다. ', '&lt;br/&gt;', '교환 책', '&lt;br/&gt;', '&lt;img src=', #{library.LIBRARY_COVER}, ' width="200px" height="100px"', '/&gt;', '&lt;br/&gt;', #{library.LIBRARY_TITLE}, '&lt;br/&gt;', '교환 일: ', #{CHANGE_DATE}), 0, now())	
		</insert>
		

		
		
	  </mapper>
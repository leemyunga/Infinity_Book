<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
	<mapper namespace="kr.co.book.transaction.dao.RentDAO">   	 
	
		<!-- 대여 신청 -->
		<insert id="rentapply" parameterType="hashmap">
			INSERT INTO RENT(LIBRARY_IDX, MEMBER_IDX, RENT_DEPOSIT, RENT_STARTDATE, RENT_ENDDATE, RENT_STATE)
			VALUES(#{LIBRARY_IDX},#{MEMBER_IDX},#{RENT_DEPOSIT},#{RENT_STARTDATE},#{RENT_ENDDATE},0)
		</insert>
		
		<!-- 대여 IDX -->
		<select id="findrent_idx" parameterType="hashmap" resultType="String">		
			SELECT RENT_IDX  FROM RENT
			WHERE LIBRARY_IDX = #{LIBRARY_IDX} AND MEMBER_IDX = #{MEMBER_IDX}			
		</select>
		
		<!-- 대화방 만들기 -->
		<insert id="createchatroom">
			INSERT INTO CHAT_ROOM(CODE_IDX,MEMBER_IDX,IDX,CHAT_ROOM_STATE) 
			VALUES(#{param1},#{param2},#{param3},0)
		</insert>
		
		<!-- 신청내역 대화방에 뿌려주기-->
		<insert id="applychatcontent">
			INSERT INTO CHAT(CODE_IDX,IDX,CHAT_SENDER,CHAT_RECIEVER,CHAT_CHAT,CHAT_CHECK,CHAT_DATE)
			VALUES(#{param1},#{param2},#{param3},#{param4},'안녕하세요',0,now())
		</insert>		
		
		<!-- 대여신청 책에 대한 정보(회원 idx, 책이름) 들고오기 -->
		<select id="findchbmidx" parameterType="hashmap" resultType="rent">		
			SELECT * FROM LIBRARY WHERE LIBRARY_IDX = #{LIBRARY_IDX} 
		</select>	
		
		<!-- 처음 대여 신청정보 -->
		<select id="rentreservation" resultType="hashmap">
			SELECT RENT_IDX, RENT_DEPOSIT, RENT_STARTDATE, RENT_ENDDATE FROM RENT
			WHERE RENT_IDX =#{param1}
		</select>
		
		<!-- 대여 약속 잡기 -->
		<update id="updaterent" parameterType="hashmap">
			UPDATE RENT SET RENT_DEPOSIT = #{RENT_DEPOSIT}, RENT_STARTDATE = #{RENT_STARTDATE}, 
			RENT_ENDDATE =  #{RENT_ENDDATE}, RENT_STATE = 1, MOD_MEMBER_IDX = #{MOD_MEMBER_IDX}, MOD_DATE = now()
			WHERE RENT_IDX = #{RENT_IDX}
		</update>
		
		<!-- 대여 약속정보 메세지 보내기 -->
		<insert id="chatrentreservation" parameterType="hashmap">		 
		    INSERT INTO CHAT(CODE_IDX, IDX, CHAT_SENDER, CHAT_RECIEVER, CHAT_CHAT, CHAT_CHECK, CHAT_DATE)
		    VALUES(#{CODE_IDX}, #{RENT_IDX}, #{MOD_MEMBER_IDX}, #{other_nick}, CONCAT('약속을 잡으셨습니다. ', '&lt;br/&gt;', '보증금: ', #{RENT_DEPOSIT}, '&lt;br/&gt;', '대여일: ', #{RENT_STARTDATE}, '&lt;br/&gt;', '반납일: ', #{RENT_ENDDATE}), 0, now())	
		</insert>
		
		
		
		
	</mapper>